<% content_for :layout do %>
  <%= render template: 'layouts/verification' %>
<% end %>

<div class="card">
  <div class="card-header">
    <h2 class="h5 mb-0">Step 1: Personal Information</h2>
  </div>
  <div class="card-body">
    <p class="text-muted mb-4">Please provide your personal information. All fields marked with * are required.</p>
    
    <%= form_with model: @claimant, url: update_step_verification_path(@claim.tracking_id, step: 'personal_info'), method: :post, class: 'needs-validation', novalidate: true do |f| %>
      <div class="mb-3">
        <%= f.label :full_name, 'Full Name *', class: 'form-label' %>
        <%= f.text_field :full_name, class: 'form-control', required: true %>
        <div class="invalid-feedback">
          Please provide your full name.
        </div>
      </div>
      
      <div class="mb-3">
        <%= f.label :email, 'Email Address *', class: 'form-label' %>
        <%= f.email_field :email, class: 'form-control', required: true %>
        <div class="invalid-feedback">
          Please provide a valid email address.
        </div>
      </div>
      
      <% if @claim.requirements.verification_steps.dig('personal_info', 'modes', 'phone') %>
        <div class="mb-3">
          <%= f.label :phone, 'Phone Number *', class: 'form-label' %>
          <%= f.telephone_field :phone, class: 'form-control', required: true %>
          <div class="invalid-feedback">
            Please provide a valid phone number.
          </div>
        </div>
      <% end %>
      
      <div class="mb-3">
        <%= f.label :date_of_birth, 'Date of Birth *', class: 'form-label' %>
        <%= f.date_field :date_of_birth, class: 'form-control', required: true %>
        <div class="invalid-feedback">
          Please provide your date of birth.
        </div>
        <div class="form-text">
          Your date of birth is required for verification purposes.
        </div>
      </div>
      
      <div class="mb-3">
        <%= f.label :ssn, 'Social Security Number *', class: 'form-label' %>
        <%= f.text_field :ssn, class: 'form-control', required: true, pattern: '\d{3}-\d{2}-\d{4}', placeholder: 'XXX-XX-XXXX' %>
        <div class="invalid-feedback">
          Please provide a valid SSN in the format XXX-XX-XXXX.
        </div>
        <div class="form-text">
          Your SSN is required for verification purposes and will be securely stored.
        </div>
      </div>
      
      <div class="d-flex justify-content-end mt-4">
        <%= f.submit 'Next', class: 'btn btn-primary' %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Form validation
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        form.classList.add('was-validated');
      }, false);
    });
    
    // Format SSN as user types
    const ssnInput = document.getElementById('claimant_ssn');
    if (ssnInput) {
      ssnInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 9) {
          value = value.slice(0, 9);
        }
        
        if (value.length > 5) {
          value = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5);
        } else if (value.length > 3) {
          value = value.slice(0, 3) + '-' + value.slice(3);
        }
        
        e.target.value = value;
      });
    }
  });
</script>