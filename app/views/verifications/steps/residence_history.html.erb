<% content_for :layout do %>
  <%= render template: 'layouts/verification' %>
<% end %>

<div class="card mb-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Residence History</h2>
  </div>
  <div class="card-body">
    <p class="text-muted mb-4">Please provide your residence history for the past <%= @required_years %> years. You must account for the entire period with no gaps.</p>
    
    <div class="timeline-visualization">
      <h6>Timeline Coverage</h6>
      <p class="text-muted">Required: <%= @required_years %> years | Provided: <%= @residence_history.total_years.round(1) %> years</p>
      
      <div class="timeline-bar">
        <% 
          # Calculate the percentage of required years covered
          coverage_percent = [(@residence_history.total_years / @required_years) * 100, 100].min
        %>
        <div class="timeline-segment" style="width: <%= coverage_percent %>%;"></div>
      </div>
      
      <div class="timeline-labels">
        <span>Today - <%= @required_years %> years</span>
        <span>Today</span>
      </div>
    </div>
    
    <% if @residence_entries.any? %>
      <h6 class="mb-3">Your Addresses</h6>
      <div class="table-responsive mb-4">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Address</th>
              <th>City</th>
              <th>State/Province</th>
              <th>Country</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Duration</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @residence_entries.each do |entry| %>
              <tr>
                <td><%= entry.address %></td>
                <td><%= entry.city %></td>
                <td><%= entry.state_province %></td>
                <td><%= entry.country %></td>
                <td><%= entry.start_date&.strftime('%Y-%m-%d') %></td>
                <td><%= entry.is_current ? 'Current' : entry.end_date&.strftime('%Y-%m-%d') %></td>
                <td><%= entry.duration_years.round(1) %> years</td>
                <td>
                  <%= link_to '#', class: 'btn btn-sm btn-outline-danger', data: { bs_toggle: 'modal', bs_target: "#deleteModal#{entry.id}" } do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                  
                  <!-- Delete Modal -->
                  <div class="modal fade" id="deleteModal<%= entry.id %>" tabindex="-1" aria-labelledby="deleteModalLabel<%= entry.id %>" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteModalLabel<%= entry.id %>">Confirm Deletion</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete this residence entry?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <%= link_to 'Delete', '#', class: 'btn btn-danger' %>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
    
    <button class="btn btn-outline-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#addResidenceForm" aria-expanded="false" aria-controls="addResidenceForm">
      <i class="bi bi-plus-circle"></i> Add Residence
    </button>
    
    <div class="collapse <%= 'show' if @residence_entries.empty? %>" id="addResidenceForm">
      <div class="card">
        <div class="card-header bg-light">
          <h3 class="h6 mb-0">Add Residence</h3>
        </div>
        <div class="card-body">
          <%= form_with model: ResidenceEntry.new, url: update_step_verification_path(@claim.tracking_id, step: 'residence_history'), method: :post, class: 'needs-validation', novalidate: true do |f| %>
            <div class="row">
              <div class="col-md-12 mb-3">
                <%= f.label :address, 'Street Address *', class: 'form-label' %>
                <%= f.text_field :address, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a street address.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :city, 'City *', class: 'form-label' %>
                <%= f.text_field :city, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a city.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :state_province, 'State/Province *', class: 'form-label' %>
                <%= f.text_field :state_province, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a state or province.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :zip_postal, 'ZIP/Postal Code *', class: 'form-label' %>
                <%= f.text_field :zip_postal, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a ZIP or postal code.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :country, 'Country *', class: 'form-label' %>
                <%= f.text_field :country, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a country.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :start_date, 'Start Date *', class: 'form-label' %>
                <%= f.date_field :start_date, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a start date.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :end_date, 'End Date', class: 'form-label' %>
                <%= f.date_field :end_date, class: 'form-control', disabled: false %>
                <div class="invalid-feedback">
                  Please provide an end date.
                </div>
              </div>
              
              <div class="col-md-12 mb-3">
                <div class="form-check">
                  <%= f.check_box :is_current, class: 'form-check-input', id: 'is_current_residence' %>
                  <%= f.label :is_current, 'I currently live at this address', class: 'form-check-label' %>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#addResidenceForm">
                Cancel
              </button>
              <%= f.submit 'Save Residence', class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <%= form_with url: update_step_verification_path(@claim.tracking_id, step: 'residence_history'), method: :post do |f| %>
      <%= f.hidden_field :complete_step, value: 'true' %>
      
      <div class="d-flex justify-content-between mt-4">
        <% previous_step = @claim.requirements.consents_required?('driver_license') || 
                           @claim.requirements.consents_required?('drug_test') || 
                           @claim.requirements.consents_required?('biometric') ? 'consents' : 'personal_info' %>
        <%= link_to 'Back', step_verification_path(@claim.tracking_id, step: previous_step), class: 'btn btn-outline-secondary' %>
        
        <% if @residence_history.total_years >= @required_years %>
          <%= f.submit 'Next', class: 'btn btn-primary' %>
        <% else %>
          <button type="button" class="btn btn-primary" disabled>
            Next (Need <%= (@required_years - @residence_history.total_years).round(1) %> more years)
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Form validation
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        form.classList.add('was-validated');
      }, false);
    });
    
    // Handle current residence checkbox
    const currentResidenceCheckbox = document.getElementById('is_current_residence');
    const endDateField = document.querySelector('input[name="residence_entry[end_date]"]');
    
    if (currentResidenceCheckbox && endDateField) {
      currentResidenceCheckbox.addEventListener('change', function() {
        endDateField.disabled = this.checked;
        if (this.checked) {
          endDateField.value = '';
          endDateField.removeAttribute('required');
        } else {
          endDateField.setAttribute('required', 'required');
        }
      });
    }
  });
</script>