<% content_for :layout do %>
  <%= render template: 'layouts/verification' %>
<% end %>

<div class="card mb-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Professional Licenses</h2>
  </div>
  <div class="card-body">
    <p class="text-muted mb-4">Please provide information about your professional licenses or certifications.</p>
    
    <% if @professional_license_entries.any? %>
      <div class="table-responsive mb-4">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>License Type</th>
              <th>License Number</th>
              <th>Issuing Authority</th>
              <th>Issue Date</th>
              <th>Expiration Date</th>
              <th>Status</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @professional_license_entries.each do |entry| %>
              <tr>
                <td><%= entry.license_type %></td>
                <td><%= entry.license_number %></td>
                <td><%= entry.issuing_authority %></td>
                <td><%= entry.issue_date&.strftime('%Y-%m-%d') %></td>
                <td><%= entry.expiration_date&.strftime('%Y-%m-%d') %></td>
                <td><%= entry.is_active ? 'Active' : 'Inactive' %></td>
                <td><%= "#{entry.state}, #{entry.country}" %></td>
                <td>
                  <%= link_to '#', class: 'btn btn-sm btn-outline-danger', data: { bs_toggle: 'modal', bs_target: "#deleteModal#{entry.id}" } do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                  
                  <!-- Delete Modal -->
                  <div class="modal fade" id="deleteModal<%= entry.id %>" tabindex="-1" aria-labelledby="deleteModalLabel<%= entry.id %>" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteModalLabel<%= entry.id %>">Confirm Deletion</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to delete this license entry?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <%= link_to 'Delete', '#', class: 'btn btn-danger' %>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
    
    <button class="btn btn-outline-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#addLicenseForm" aria-expanded="false" aria-controls="addLicenseForm">
      <i class="bi bi-plus-circle"></i> Add Professional License
    </button>
    
    <div class="collapse <%= 'show' if @professional_license_entries.empty? %>" id="addLicenseForm">
      <div class="card">
        <div class="card-header bg-light">
          <h3 class="h6 mb-0">Add Professional License</h3>
        </div>
        <div class="card-body">
          <%= form_with model: ProfessionalLicenseEntry.new, url: update_step_verification_path(@claim.tracking_id, step: 'professional_licenses'), method: :post, class: 'needs-validation', novalidate: true do |f| %>
            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :license_type, 'License Type *', class: 'form-label' %>
                <%= f.text_field :license_type, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a license type.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :license_number, 'License Number *', class: 'form-label' %>
                <%= f.text_field :license_number, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a license number.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :issuing_authority, 'Issuing Authority *', class: 'form-label' %>
                <%= f.text_field :issuing_authority, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide an issuing authority.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :issue_date, 'Issue Date *', class: 'form-label' %>
                <%= f.date_field :issue_date, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide an issue date.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :expiration_date, 'Expiration Date *', class: 'form-label' %>
                <%= f.date_field :expiration_date, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide an expiration date.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                  <%= f.check_box :is_active, class: 'form-check-input', id: 'is_active_license' %>
                  <%= f.label :is_active, 'This license is currently active', class: 'form-check-label' %>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :state, 'State/Province *', class: 'form-label' %>
                <%= f.text_field :state, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a state or province.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :country, 'Country *', class: 'form-label' %>
                <%= f.text_field :country, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a country.
                </div>
              </div>
              
              <div class="col-md-12 mb-3">
                <%= f.label :description, 'Description', class: 'form-label' %>
                <%= f.text_area :description, class: 'form-control', rows: 3 %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :start_date, 'Start Date *', class: 'form-label' %>
                <%= f.date_field :start_date, class: 'form-control', required: true %>
                <div class="invalid-feedback">
                  Please provide a start date.
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :end_date, 'End Date', class: 'form-label' %>
                <%= f.date_field :end_date, class: 'form-control', disabled: false %>
                <div class="invalid-feedback">
                  Please provide an end date.
                </div>
              </div>
              
              <div class="col-md-12 mb-3">
                <div class="form-check">
                  <%= f.check_box :is_current, class: 'form-check-input', id: 'is_current_license' %>
                  <%= f.label :is_current, 'This is my current license', class: 'form-check-label' %>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#addLicenseForm">
                Cancel
              </button>
              <%= f.submit 'Save License', class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <%= form_with url: update_step_verification_path(@claim.tracking_id, step: 'professional_licenses'), method: :post do |f| %>
      <%= f.hidden_field :complete_step, value: 'true' %>
      
      <div class="d-flex justify-content-between mt-4">
        <% 
          previous_step = if @claim.requirements.verification_step_enabled?('education')
            'education'
          elsif @claim.requirements.verification_step_enabled?('employment_history')
            'employment_history'
          elsif @claim.requirements.verification_step_enabled?('residence_history')
            'residence_history'
          elsif @claim.requirements.consents_required?('driver_license') || 
                @claim.requirements.consents_required?('drug_test') || 
                @claim.requirements.consents_required?('biometric')
            'consents'
          else
            'personal_info'
          end
        %>
        <%= link_to 'Back', step_verification_path(@claim.tracking_id, step: previous_step), class: 'btn btn-outline-secondary' %>
        
        <% if @professional_license_entries.any? %>
          <%= f.submit 'Next', class: 'btn btn-primary' %>
        <% else %>
          <button type="button" class="btn btn-primary" disabled>
            Next (Add at least one license)
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Form validation
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        form.classList.add('was-validated');
      }, false);
    });
    
    // Handle current license checkbox
    const currentLicenseCheckbox = document.getElementById('is_current_license');
    const endDateField = document.querySelector('input[name="professional_license_entry[end_date]"]');
    
    if (currentLicenseCheckbox && endDateField) {
      currentLicenseCheckbox.addEventListener('change', function() {
        endDateField.disabled = this.checked;
        if (this.checked) {
          endDateField.value = '';
          endDateField.removeAttribute('required');
        } else {
          endDateField.setAttribute('required', 'required');
        }
      });
    }
    
    // Handle active license checkbox
    const activeLicenseCheckbox = document.getElementById('is_active_license');
    const expirationDateField = document.querySelector('input[name="professional_license_entry[expiration_date]"]');
    
    if (activeLicenseCheckbox && expirationDateField) {
      activeLicenseCheckbox.addEventListener('change', function() {
        // If license is active, ensure expiration date is in the future
        if (this.checked) {
          const today = new Date();
          const minDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString().split('T')[0];
          expirationDateField.min = minDate;
        } else {
          expirationDateField.removeAttribute('min');
        }
      });
    }
  });
</script>