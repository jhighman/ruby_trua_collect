<% content_for :layout do %>
  <%= render template: 'layouts/verification' %>
<% end %>

<div class="card mb-4">
  <div class="card-header">
    <h2 class="h5 mb-0">Education</h2>
  </div>
  <div class="card-body">
    <p class="text-muted mb-4">Please provide information about your educational background.</p>
    
    <%= form_with model: @education, url: update_step_verification_path(@claim.tracking_id, step: 'education'), method: :post, class: 'needs-validation mb-4', novalidate: true do |f| %>
      <div class="mb-4">
        <%= f.label :highest_level, 'Highest Level of Education *', class: 'form-label' %>
        <%= f.select :highest_level, [
          ['Less than High School', 'Less than High School'],
          ['High School or GED', 'High School or GED'],
          ['Some College (no degree)', 'Some College (no degree)'],
          ['Associate\'s Degree', 'Associate\'s Degree'],
          ['Bachelor\'s Degree', 'Bachelor\'s Degree'],
          ['Master\'s Degree', 'Master\'s Degree'],
          ['Doctorate (PhD, EdD, etc.)', 'Doctorate (PhD, EdD, etc.)'],
          ['Professional Degree (MD, JD, etc.)', 'Professional Degree (MD, JD, etc.)']
        ], { include_blank: 'Select highest level' }, { class: 'form-select', required: true, id: 'highest_level_select' } %>
        <div class="invalid-feedback">
          Please select your highest level of education.
        </div>
      </div>
      
      <div class="d-flex justify-content-end">
        <%= f.submit 'Save', class: 'btn btn-primary' %>
      </div>
    <% end %>
    
    <div id="education_entries_section" class="<%= 'd-none' if @education&.highest_level.nil? || @education&.highest_level == 'Less than High School' || @education&.highest_level == 'High School or GED' %>">
      <hr>
      
      <h3 class="h6 mb-3">Education Details</h3>
      
      <% if @education_entries.any? %>
        <div class="table-responsive mb-4">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Institution</th>
                <th>Degree</th>
                <th>Field of Study</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Location</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @education_entries.each do |entry| %>
                <tr>
                  <td><%= entry.institution %></td>
                  <td><%= entry.degree %></td>
                  <td><%= entry.field_of_study %></td>
                  <td><%= entry.start_date&.strftime('%Y-%m-%d') %></td>
                  <td><%= entry.is_current ? 'Current' : entry.end_date&.strftime('%Y-%m-%d') %></td>
                  <td><%= entry.location %></td>
                  <td>
                    <%= link_to '#', class: 'btn btn-sm btn-outline-danger', data: { bs_toggle: 'modal', bs_target: "#deleteModal#{entry.id}" } do %>
                      <i class="bi bi-trash"></i>
                    <% end %>
                    
                    <!-- Delete Modal -->
                    <div class="modal fade" id="deleteModal<%= entry.id %>" tabindex="-1" aria-labelledby="deleteModalLabel<%= entry.id %>" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel<%= entry.id %>">Confirm Deletion</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to delete this education entry?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <%= link_to 'Delete', '#', class: 'btn btn-danger' %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
      
      <button class="btn btn-outline-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#addEducationForm" aria-expanded="false" aria-controls="addEducationForm">
        <i class="bi bi-plus-circle"></i> Add Education
      </button>
      
      <div class="collapse <%= 'show' if @education_entries.empty? && @education&.highest_level.present? && @education.highest_level != 'Less than High School' && @education.highest_level != 'High School or GED' %>" id="addEducationForm">
        <div class="card">
          <div class="card-header bg-light">
            <h3 class="h6 mb-0">Add Education</h3>
          </div>
          <div class="card-body">
            <%= form_with model: EducationEntry.new, url: update_step_verification_path(@claim.tracking_id, step: 'education'), method: :post, class: 'needs-validation', novalidate: true do |f| %>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= f.label :institution, 'Institution *', class: 'form-label' %>
                  <%= f.text_field :institution, class: 'form-control', required: true %>
                  <div class="invalid-feedback">
                    Please provide an institution name.
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= f.label :degree, 'Degree *', class: 'form-label' %>
                  <%= f.text_field :degree, class: 'form-control', required: true %>
                  <div class="invalid-feedback">
                    Please provide a degree.
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= f.label :field_of_study, 'Field of Study *', class: 'form-label' %>
                  <%= f.text_field :field_of_study, class: 'form-control', required: true %>
                  <div class="invalid-feedback">
                    Please provide a field of study.
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= f.label :location, 'Location', class: 'form-label' %>
                  <%= f.text_field :location, class: 'form-control' %>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= f.label :start_date, 'Start Date *', class: 'form-label' %>
                  <%= f.date_field :start_date, class: 'form-control', required: true %>
                  <div class="invalid-feedback">
                    Please provide a start date.
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= f.label :end_date, 'End Date', class: 'form-label' %>
                  <%= f.date_field :end_date, class: 'form-control', disabled: false %>
                  <div class="invalid-feedback">
                    Please provide an end date.
                  </div>
                </div>
                
                <div class="col-md-12 mb-3">
                  <div class="form-check">
                    <%= f.check_box :is_current, class: 'form-check-input', id: 'is_current_education' %>
                    <%= f.label :is_current, 'I am currently studying here', class: 'form-check-label' %>
                  </div>
                </div>
                
                <div class="col-md-12 mb-3">
                  <%= f.label :description, 'Description', class: 'form-label' %>
                  <%= f.text_area :description, class: 'form-control', rows: 3 %>
                </div>
              </div>
              
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#addEducationForm">
                  Cancel
                </button>
                <%= f.submit 'Save Education', class: 'btn btn-primary' %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <%= form_with url: update_step_verification_path(@claim.tracking_id, step: 'education'), method: :post do |f| %>
      <%= f.hidden_field :complete_step, value: 'true' %>
      
      <div class="d-flex justify-content-between mt-4">
        <% 
          previous_step = if @claim.requirements.verification_step_enabled?('employment_history')
            'employment_history'
          elsif @claim.requirements.verification_step_enabled?('residence_history')
            'residence_history'
          elsif @claim.requirements.consents_required?('driver_license') || 
                @claim.requirements.consents_required?('drug_test') || 
                @claim.requirements.consents_required?('biometric')
            'consents'
          else
            'personal_info'
          end
        %>
        <%= link_to 'Back', step_verification_path(@claim.tracking_id, step: previous_step), class: 'btn btn-outline-secondary' %>
        
        <% if @education&.highest_level.present? && 
              (@education.highest_level == 'Less than High School' || 
               @education.highest_level == 'High School or GED' || 
               @education_entries.any?) %>
          <%= f.submit 'Next', class: 'btn btn-primary' %>
        <% else %>
          <button type="button" class="btn btn-primary" disabled>
            Next (Complete education information)
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Form validation
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        form.classList.add('was-validated');
      }, false);
    });
    
    // Handle current education checkbox
    const currentEducationCheckbox = document.getElementById('is_current_education');
    const endDateField = document.querySelector('input[name="education_entry[end_date]"]');
    
    if (currentEducationCheckbox && endDateField) {
      currentEducationCheckbox.addEventListener('change', function() {
        endDateField.disabled = this.checked;
        if (this.checked) {
          endDateField.value = '';
          endDateField.removeAttribute('required');
        } else {
          endDateField.setAttribute('required', 'required');
        }
      });
    }
    
    // Handle highest level selection
    const highestLevelSelect = document.getElementById('highest_level_select');
    const educationEntriesSection = document.getElementById('education_entries_section');
    
    if (highestLevelSelect && educationEntriesSection) {
      highestLevelSelect.addEventListener('change', function() {
        const selectedLevel = this.value;
        
        if (selectedLevel === 'Less than High School' || selectedLevel === 'High School or GED') {
          educationEntriesSection.classList.add('d-none');
        } else {
          educationEntriesSection.classList.remove('d-none');
        }
      });
    }
  });
</script>