<%= render layout: 'form_submissions/form', locals: { step_title: 'Employment History' } do |form| %>
  <div class="space-y-4">
    <p class="text-sm text-muted-foreground">Please provide your employment history for the past <%= @requirements.employment_history_years %> years.</p>
    
    <div data-form-target="timelineEntries" class="mb-4">
      <!-- Timeline entries will be dynamically rendered here by the FormController -->
      <% if @step_data && @step_data['values'] && @step_data['values']['entries'] && @step_data['values']['entries'].any? %>
        <% @step_data['values']['entries'].each_with_index do |entry, index| %>
          <div class="timeline-entry mb-3 border rounded p-4 bg-white">
            <div class="flex justify-between">
              <h5 class="font-medium"><%= entry['company'] %> - <%= entry['position'] %></h5>
              <a href="<%= form_submission_path(id: @form_submission.id, step_id: @step_id, entry_index: index) %>"
                 data-method="delete"
                 data-confirm="Are you sure you want to remove this employment entry?"
                 class="text-red-600 hover:text-red-800">Remove</a>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
              <div>
                <p class="text-sm text-muted-foreground">Start Date</p>
                <p><%= entry['start_date'] %></p>
              </div>
              <div>
                <p class="text-sm text-muted-foreground">End Date</p>
                <p><%= entry['is_current'] ? 'Current' : entry['end_date'] %></p>
              </div>
            </div>
            <div class="mt-2">
              <p class="text-sm text-muted-foreground">Location</p>
              <p><%= entry['city'] %>, <%= entry['state_province'] %>, <%= entry['country'] %></p>
            </div>
            <% if entry['description'].present? %>
              <div class="mt-2">
                <p class="text-sm text-muted-foreground">Description</p>
                <p><%= entry['description'] %></p>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <%= render_card title: "Add New Employment", class: "w-full" do %>
      <%= form_with url: form_submission_path(id: @form_submission.id, step_id: @step_id), method: :patch, html: { data: { action: 'submit->form#addTimelineEntry' } }, authenticity_token: true do |entry_form| %>
        <!-- Current employer toggle moved to the top -->
        <div class="flex items-start space-x-2 mb-6 p-3 bg-gray-50 rounded-md border border-gray-200">
          <input type="checkbox"
                 name="entry[is_current]"
                 id="entry_is_current"
                 class="h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary"
                 data-action="change->form#toggleEndDate"
                 data-form-target="field">
          <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="entry_is_current">
            This is my current employer
          </label>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="space-y-2">
            <%= render_label name: 'entry[company]', label: 'Company' %>
            <%= render_input name: 'entry[company]',
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
          <div class="space-y-2">
            <%= render_label name: 'entry[position]', label: 'Position' %>
            <%= render_input name: 'entry[position]',
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="space-y-2">
            <%= render_label name: 'entry[start_date]', label: 'Start Date' %>
            <%= render_input name: 'entry[start_date]',
                           type: :date,
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
          <div class="space-y-2" id="end-date-container">
            <%= render_label name: 'entry[end_date]', label: 'End Date' %>
            <%= render_input name: 'entry[end_date]',
                           type: :date,
                           required: true,
                           data: { form_target: 'field' },
                           id: 'entry_end_date' %>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="space-y-2">
            <%= render_label name: 'entry[city]', label: 'City' %>
            <%= render_input name: 'entry[city]',
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
          <div class="space-y-2">
            <%= render_label name: 'entry[state_province]', label: 'State/Province' %>
            <%= render_input name: 'entry[state_province]',
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
          <div class="space-y-2">
            <%= render_label name: 'entry[country]', label: 'Country' %>
            <%= render_input name: 'entry[country]',
                           required: true,
                           data: { form_target: 'field' } %>
          </div>
        </div>
        
        <!-- Contact Information Section -->
        <div class="mb-6 border-t pt-4 mt-4">
          <h3 class="text-lg font-medium mb-4">Contact Information</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="space-y-2">
              <%= render_label name: 'entry[contact_name]', label: 'Contact Name' %>
              <%= render_input name: 'entry[contact_name]',
                             required: true,
                             data: { form_target: 'field' } %>
            </div>
            <div class="flex items-start space-x-2 mt-8">
              <input type="checkbox"
                     name="entry[no_contact]"
                     id="entry_no_contact"
                     class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                     data-action="change->form#toggleContactFields"
                     data-form-target="field">
              <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="entry_no_contact">
                I don't have a contact for this employer
              </label>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="contact-fields-container">
            <div class="space-y-2">
              <%= render_label name: 'entry[contact_email]', label: 'Contact Email' %>
              <%= render_input name: 'entry[contact_email]',
                             type: :email,
                             required: false,
                             data: { form_target: 'field' } %>
            </div>
            <div class="space-y-2">
              <%= render_label name: 'entry[contact_phone]', label: 'Contact Phone Number' %>
              <%= render_input name: 'entry[contact_phone]',
                             required: false,
                             data: { form_target: 'field' } %>
            </div>
          </div>
          
          <div id="no-contact-warning" class="p-4 mb-4 border border-yellow-300 bg-yellow-50 rounded-md text-yellow-800 hidden">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Important notice</h3>
                <div class="mt-2 text-sm text-yellow-700">
                  <p>Without a contact for this employer, there may be delays in verifying your employment history. This could potentially slow down your application process.</p>
                </div>
              </div>
            </div>
          </div>
          
          <p class="text-sm text-gray-500 italic">Either contact email or phone number is required unless "I don't have a contact" is checked.</p>
        </div>
        
        <div class="space-y-2 mb-4">
          <%= render_label name: 'entry[description]', label: 'Job Description' %>
          <%= render_input name: 'entry[description]',
                         type: :textarea,
                         required: false,
                         data: { form_target: 'field' } %>
        </div>
        
        <div class="flex justify-end">
          <%= render_button 'Add Employment', as: :submit, name: 'commit', value: 'Add Employment' %>
        </div>
      <% end %>
    <% end %>
  </div>
  
  <div data-form-target="navigation" class="flex justify-between mt-6">
    <!-- Navigation buttons will be dynamically rendered here by the FormController -->
  </div>
  
  <div class="flex justify-end mt-6">
    <%= render_button 'Next', as: :submit, name: 'commit', value: 'Next' %>
  </div>
<% end %>